<template>
    <div class="add-spot-page">
        <!-- È°∂ÈÉ®ÂØºËà™ -->
        <van-nav-bar 
            title="Ê∑ªÂä†ÈíìÁÇπ" 
            left-arrow 
            @click-left="$router.back()"
        >
            <template #right>
                <van-button 
                    type="primary" 
                    size="small"
                    :loading="submitting"
                    @click="submitSpot"
                >
                    Êèê‰∫§
                </van-button>
            </template>
        </van-nav-bar>

        <div class="add-spot-content">
            <van-form @submit="submitSpot">
                <!-- Âü∫Êú¨‰ø°ÊÅØ -->
                <div class="form-section">
                    <h3>Âü∫Êú¨‰ø°ÊÅØ</h3>
                    
                    <van-field
                        v-model="formData.name"
                        label="ÈíìÁÇπÂêçÁß∞"
                        placeholder="ËØ∑ËæìÂÖ•ÈíìÁÇπÂêçÁß∞"
                        required
                        :rules="[{ required: true, message: 'ËØ∑ËæìÂÖ•ÈíìÁÇπÂêçÁß∞' }]"
                    />

                    <van-field
                        v-model="formData.typeText"
                        label="ÈíìÁÇπÁ±ªÂûã"
                        placeholder="ËØ∑ÈÄâÊã©ÈíìÁÇπÁ±ªÂûã"
                        readonly
                        required
                        @click="showTypePicker = true"
                    />

                    <van-field
                        v-model="formData.description"
                        label="ÈíìÁÇπÊèèËø∞"
                        type="textarea"
                        placeholder="ËØ∑ËØ¶ÁªÜÊèèËø∞ÈíìÁÇπÁâπËâ≤„ÄÅÁéØÂ¢É„ÄÅÈ±ºÊÉÖÁ≠â‰ø°ÊÅØ..."
                        rows="3"
                        maxlength="200"
                        show-word-limit
                        required
                        :rules="[{ required: true, message: 'ËØ∑ËæìÂÖ•ÈíìÁÇπÊèèËø∞' }]"
                    />
                </div>

                <!-- ‰ΩçÁΩÆ‰ø°ÊÅØ -->
                <div class="form-section">
                    <h3>‰ΩçÁΩÆ‰ø°ÊÅØ</h3>
                    
                    <div class="location-section">
                        <van-button 
                            type="primary" 
                            block 
                            icon="location-o"
                            @click="selectLocation"
                        >
                            {{ locationText }}
                        </van-button>
                        
                        <div v-if="formData.latitude && formData.longitude" class="location-info">
                            <div class="location-item">
                                <span class="label">Á∫¨Â∫¶:</span>
                                <span class="value">{{ formData.latitude.toFixed(6) }}</span>
                            </div>
                            <div class="location-item">
                                <span class="label">ÁªèÂ∫¶:</span>
                                <span class="value">{{ formData.longitude.toFixed(6) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- È±ºÁßç‰ø°ÊÅØ -->
                <div class="form-section">
                    <h3>È±ºÁßç‰ø°ÊÅØ</h3>
                    
                    <van-field
                        v-model="fishSpeciesInput"
                        label="ÂèØÈíìÈ±ºÁßç"
                        placeholder="ËæìÂÖ•È±ºÁßçÂêçÁß∞ÂêéÂõûËΩ¶Ê∑ªÂä†"
                        @keyup.enter="addFishSpecies"
                    >
                        <template #button>
                            <van-button 
                                size="small" 
                                type="primary"
                                @click="addFishSpecies"
                            >
                                Ê∑ªÂä†
                            </van-button>
                        </template>
                    </van-field>

                    <div class="fish-species-tags">
                        <van-tag
                            v-for="(species, index) in formData.fishSpecies"
                            :key="index"
                            type="primary"
                            closeable
                            @close="removeFishSpecies(index)"
                        >
                            üêü {{ species }}
                        </van-tag>
                        <div v-if="formData.fishSpecies.length === 0" class="empty-tip">
                            ËØ∑Ê∑ªÂä†ÂèØÈíìÈ±ºÁßç
                        </div>
                    </div>
                </div>



                <!-- ÂõæÁâá‰∏ä‰º† -->
                <div class="form-section">
                    <h3>ÈíìÁÇπÂõæÁâá</h3>
                    
                    <van-uploader
                        v-model="formData.images"
                        multiple
                        :max-count="6"
                        :after-read="afterRead"
                        :before-delete="beforeDelete"
                    >
                        <div class="upload-tip">
                            <van-icon name="photograph" size="24" />
                            <p>‰∏ä‰º†ÈíìÁÇπÂõæÁâá (ÊúÄÂ§ö6Âº†)</p>
                        </div>
                    </van-uploader>
                </div>
            </van-form>
        </div>

        <!-- ÈíìÁÇπÁ±ªÂûãÈÄâÊã©Âô® -->
        <van-popup v-model:show="showTypePicker" position="bottom">
            <van-picker
                :columns="typeOptions"
                @confirm="onTypeConfirm"
                @cancel="showTypePicker = false"
            />
        </van-popup>

        <!-- Âú∞ÂõæÈÄâÁÇπÂºπÁ™ó -->
        <van-popup 
            v-model:show="showLocationPicker" 
            position="bottom" 
            :style="{ height: '70%' }"
        >
            <div class="location-picker">
                <div class="picker-header">
                    <h3>ÈÄâÊã©ÈíìÁÇπ‰ΩçÁΩÆ</h3>
                    <van-button 
                        type="primary" 
                        size="small"
                        @click="confirmLocation"
                    >
                        Á°ÆËÆ§‰ΩçÁΩÆ
                    </van-button>
                </div>
                
                <div class="map-container">
                    <!-- Ê®°ÊãüÂú∞Âõæ -->
                    <div class="mock-map" @click="onMapClick">
                        <div class="map-background">
                            <div class="map-grid"></div>
                            
                            <!-- ÈÄâ‰∏≠ÁöÑ‰ΩçÁΩÆÊ†áËÆ∞ -->
                            <div 
                                v-if="selectedLocation.lat && selectedLocation.lng"
                                class="selected-marker"
                                :style="getMarkerStyle(selectedLocation)"
                            >
                                <div class="marker-icon">üìç</div>
                                <div class="marker-pulse"></div>
                            </div>
                            
                            <!-- Âú∞ÂõæÊèêÁ§∫ -->
                            <div class="map-tip">
                                ÁÇπÂáªÂú∞ÂõæÈÄâÊã©ÈíìÁÇπ‰ΩçÁΩÆ
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="location-actions">
                    <van-button 
                        type="default" 
                        block
                        icon="aim"
                        @click="getCurrentLocation"
                    >
                        ‰ΩøÁî®ÂΩìÂâç‰ΩçÁΩÆ
                    </van-button>
                </div>
            </div>
        </van-popup>
    </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue';
import { useRouter } from 'vue-router';
import { showToast, showNotify, showConfirmDialog } from 'vant';
import { FishingSpotType } from '../types/fishing';

const router = useRouter();

// Ë°®ÂçïÊï∞ÊçÆ
const formData = ref({
    name: '',
    type: '',
    typeText: '',
    description: '',
    latitude: 0,
    longitude: 0,
    fishSpecies: [] as string[],

    images: [] as any[]
});

// Ë°®ÂçïÁä∂ÊÄÅ
const submitting = ref(false);
const fishSpeciesInput = ref('');

// ÂºπÁ™óÁä∂ÊÄÅ
const showTypePicker = ref(false);
const showLocationPicker = ref(false);

// ÈÄâ‰∏≠ÁöÑ‰ΩçÁΩÆ
const selectedLocation = ref({ lat: 0, lng: 0 });

// ÈíìÁÇπÁ±ªÂûãÈÄâÈ°π
const typeOptions = [
    { text: 'ÊπñÊ≥ä', value: FishingSpotType.LAKE },
    { text: 'Ê≤≥ÊµÅ', value: FishingSpotType.RIVER },
    { text: 'Ê∞¥Â∫ì', value: FishingSpotType.RESERVOIR },
    { text: 'ÈªëÂùë', value: FishingSpotType.BLACK_PIT },
    { text: 'Êµ∑Èíì', value: FishingSpotType.SALTWATER },
    { text: 'Ê∑°Ê∞¥', value: FishingSpotType.FRESHWATER }
];



// ËÆ°ÁÆóÂ±ûÊÄß
const locationText = computed(() => {
    if (formData.value.latitude && formData.value.longitude) {
        return 'Â∑≤ÈÄâÊã©‰ΩçÁΩÆ (ÁÇπÂáªÈáçÊñ∞ÈÄâÊã©)';
    }
    return 'ÁÇπÂáªÈÄâÊã©ÈíìÁÇπ‰ΩçÁΩÆ';
});

// ‰∫ã‰ª∂Â§ÑÁêÜ
const onTypeConfirm = ({ selectedOptions }: any) => {
    const selected = selectedOptions[0];
    formData.value.type = selected.value;
    formData.value.typeText = selected.text;
    showTypePicker.value = false;
};

const selectLocation = () => {
    showLocationPicker.value = true;
    if (formData.value.latitude && formData.value.longitude) {
        selectedLocation.value = {
            lat: formData.value.latitude,
            lng: formData.value.longitude
        };
    }
};

const onMapClick = (event: MouseEvent) => {
    const rect = (event.currentTarget as Element).getBoundingClientRect();
    const x = (event.clientX - rect.left) / rect.width;
    const y = (event.clientY - rect.top) / rect.height;
    
    // Ê®°ÊãüÁªèÁ∫¨Â∫¶ËΩ¨Êç¢
    const lat = 40.0 - (y - 0.5) * 0.1;
    const lng = 116.0 + (x - 0.5) * 0.1;
    
    selectedLocation.value = { lat, lng };
    showToast('‰ΩçÁΩÆÂ∑≤ÈÄâÊã©');
};

const getCurrentLocation = () => {
    // Ê®°ÊãüËé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ
    selectedLocation.value = {
        lat: 39.9042 + (Math.random() - 0.5) * 0.01,
        lng: 116.4074 + (Math.random() - 0.5) * 0.01
    };
    showToast('Â∑≤Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ');
};

const confirmLocation = () => {
    if (selectedLocation.value.lat && selectedLocation.value.lng) {
        formData.value.latitude = selectedLocation.value.lat;
        formData.value.longitude = selectedLocation.value.lng;
        showLocationPicker.value = false;
        showToast('‰ΩçÁΩÆÂ∑≤Á°ÆËÆ§');
    } else {
        showToast('ËØ∑ÂÖàÈÄâÊã©‰ΩçÁΩÆ');
    }
};

const getMarkerStyle = (location: { lat: number; lng: number }) => {
    // Ê®°Êãü‰ΩçÁΩÆËΩ¨Êç¢‰∏∫CSS‰ΩçÁΩÆ
    const x = ((location.lng - 116.0) / 0.1 + 0.5) * 100;
    const y = ((40.0 - location.lat) / 0.1 + 0.5) * 100;
    
    return {
        left: `${Math.max(5, Math.min(95, x))}%`,
        top: `${Math.max(5, Math.min(95, y))}%`
    };
};

const addFishSpecies = () => {
    const species = fishSpeciesInput.value.trim();
    if (species && !formData.value.fishSpecies.includes(species)) {
        formData.value.fishSpecies.push(species);
        fishSpeciesInput.value = '';
        showToast(`Â∑≤Ê∑ªÂä† ${species}`);
    } else if (formData.value.fishSpecies.includes(species)) {
        showToast('ËØ•È±ºÁßçÂ∑≤Â≠òÂú®');
    }
};

const removeFishSpecies = (index: number) => {
    const species = formData.value.fishSpecies[index];
    formData.value.fishSpecies.splice(index, 1);
    showToast(`Â∑≤ÁßªÈô§ ${species}`);
};

const afterRead = (file: any) => {
    console.log('‰∏ä‰º†Êñá‰ª∂:', file);
    showToast('ÂõæÁâá‰∏ä‰º†ÂäüËÉΩÂºÄÂèë‰∏≠');
};

const beforeDelete = (): Promise<boolean> => {
    return new Promise((resolve) => {
        showConfirmDialog({
            title: 'Á°ÆËÆ§Âà†Èô§',
            message: 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÂõæÁâáÂêóÔºü'
        }).then(() => {
            resolve(true);
        }).catch(() => {
            resolve(false);
        });
    });
};

const validateForm = (): boolean => {
    if (!formData.value.name.trim()) {
        showToast('ËØ∑ËæìÂÖ•ÈíìÁÇπÂêçÁß∞');
        return false;
    }
    
    if (!formData.value.type) {
        showToast('ËØ∑ÈÄâÊã©ÈíìÁÇπÁ±ªÂûã');
        return false;
    }
    
    if (!formData.value.description.trim()) {
        showToast('ËØ∑ËæìÂÖ•ÈíìÁÇπÊèèËø∞');
        return false;
    }
    
    if (!formData.value.latitude || !formData.value.longitude) {
        showToast('ËØ∑ÈÄâÊã©ÈíìÁÇπ‰ΩçÁΩÆ');
        return false;
    }
    
    if (formData.value.fishSpecies.length === 0) {
        showToast('ËØ∑Ëá≥Â∞ëÊ∑ªÂä†‰∏ÄÁßçÈ±ºÁßç');
        return false;
    }
    
    return true;
};

const submitSpot = async () => {
    if (!validateForm()) {
        return;
    }
    
    submitting.value = true;
    
    try {
        // Ê®°ÊãüÊèê‰∫§
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        showNotify({
            type: 'success',
            message: 'ÈíìÁÇπÊèê‰∫§ÊàêÂäüÔºÅÁ≠âÂæÖÁÆ°ÁêÜÂëòÂÆ°Ê†∏'
        });
        
        // Ë∑≥ËΩ¨ÂõûÂú∞ÂõæÈ°µÈù¢
        router.replace('/map');
    } catch (error) {
        showToast('Êèê‰∫§Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
    } finally {
        submitting.value = false;
    }
};
</script>

<style scoped>
.add-spot-page {
    min-height: 100vh;
    background: var(--van-background-color);
}

.add-spot-content {
    padding: 12px;
}

.form-section {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 12px rgba(30, 136, 229, 0.1);
}

.form-section h3 {
    margin: 0 0 16px 0;
    font-size: 16px;
    color: var(--van-text-color);
    font-weight: 600;
}

/* ‰ΩçÁΩÆ‰ø°ÊÅØ */
.location-section {
    margin-top: 12px;
}

.location-info {
    margin-top: 12px;
    padding: 12px;
    background: var(--van-background-color-light);
    border-radius: 8px;
}

.location-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
    font-size: 14px;
}

.location-item:last-child {
    margin-bottom: 0;
}

.label {
    color: var(--van-text-color-2);
}

.value {
    color: var(--van-text-color);
    font-weight: 500;
}

/* È±ºÁßçÊ†áÁ≠æ */
.fish-species-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
    min-height: 32px;
    align-items: center;
}

.empty-tip {
    color: var(--van-text-color-3);
    font-size: 14px;
}



/* ‰∏ä‰º†ÊèêÁ§∫ */
.upload-tip {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: var(--van-text-color-3);
}

.upload-tip p {
    margin: 8px 0 0 0;
    font-size: 14px;
}

/* Âú∞ÂõæÈÄâÁÇπ */
.location-picker {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.picker-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border-bottom: 1px solid var(--van-border-color);
}

.picker-header h3 {
    margin: 0;
    color: var(--van-text-color);
}

.map-container {
    flex: 1;
    position: relative;
}

.mock-map {
    width: 100%;
    height: 100%;
    position: relative;
    cursor: crosshair;
}

.map-background {
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, #e8f4f8 25%, transparent 25%), 
                linear-gradient(-45deg, #e8f4f8 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #e8f4f8 75%), 
                linear-gradient(-45deg, transparent 75%, #e8f4f8 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    position: relative;
}

.map-grid {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        linear-gradient(rgba(30, 136, 229, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(30, 136, 229, 0.1) 1px, transparent 1px);
    background-size: 50px 50px;
}

.selected-marker {
    position: absolute;
    transform: translate(-50%, -50%);
    z-index: 10;
}

.marker-icon {
    font-size: 24px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.marker-pulse {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--van-primary-color);
    opacity: 0.3;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.3;
    }
    100% {
        transform: translate(-50%, -50%) scale(3);
        opacity: 0;
    }
}

.map-tip {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
}

.location-actions {
    padding: 16px;
    border-top: 1px solid var(--van-border-color);
}

:deep(.van-field__label) {
    width: 80px;
}

:deep(.van-uploader) {
    margin-top: 8px;
}
</style> 